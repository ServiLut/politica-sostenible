generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id        String              @id @default(cuid())
  slug      String              @unique
  name      String
  type      TenantType          @default(CANDIDACY)
  config    Json?
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")
  finances  FinancialEntry[]
  divisions PoliticalDivision[] @relation("TenantDivisions")
  users     User[]
  voters    Voter[]
  witnesses WitnessReport[]
  events    CampaignEvent[]
  inventory InventoryItem[]
  settings  CampaignSettings?

  @@map("tenants")
}

model CampaignSettings {
  id                String   @id @default(cuid())
  tenantId          String   @unique @map("tenant_id")
  maxTotalBudget    Decimal  @db.Decimal(15, 2) @map("max_total_budget")
  maxPublicityLimit Decimal  @db.Decimal(15, 2) @map("max_publicity_limit")
  updatedAt         DateTime @updatedAt @map("updated_at")
  tenant            Tenant   @relation(fields: [tenantId], references: [id])

  @@map("campaign_settings")
}

model User {
  id               String             @id @default(cuid())
  email            String             @unique
  password         String
  name             String
  role             Role               @default(VOLUNTEER)
  documentId       String             @map("document_id")
  phone            String?
  points           Int                @default(0)
  tenantId         String             @map("tenant_id")
  divisionId       String?            @map("division_id")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  financialEntries FinancialEntry[]
  division         PoliticalDivision? @relation(fields: [divisionId], references: [id])
  tenant           Tenant             @relation(fields: [tenantId], references: [id])
  registeredVoters Voter[]            @relation("Registrar")
  witnessReports   WitnessReport[]

  // Gamification & Logistics
  pointLogs      PointLog[]
  inventoryMoves InventoryMovement[]

  @@unique([documentId, tenantId])
  @@index([tenantId])
  @@map("users")
}

model PoliticalDivision {
  id        String              @id @default(cuid())
  code      String
  name      String
  type      DivisionType
  parentId  String?             @map("parent_id")
  tenantId  String?             @map("tenant_id")
  parent    PoliticalDivision?  @relation("Hierarchy", fields: [parentId], references: [id])
  children  PoliticalDivision[] @relation("Hierarchy")
  tenant    Tenant?             @relation("TenantDivisions", fields: [tenantId], references: [id])
  users     User[]
  voters    Voter[]             @relation("VoterPuesto")
  witnesses WitnessReport[]

  @@unique([code, type])
  @@index([type])
  @@map("political_divisions")
}

model Voter {
  id                String             @id @default(cuid())
  documentId        String             @map("document_id")
  firstName         String             @map("first_name")
  lastName          String             @map("last_name")
  phone             String?
  email             String?
  tenantId          String             @map("tenant_id")
  puestoId          String?            @map("puesto_id")
  mesa              Int?
  registrarId       String             @map("registrar_id")
  psychographicData Json?              @map("psychographic_data")
  votingIntention   Int?               @map("voting_intention")
  isSignatureValid  Boolean            @default(false) @map("is_signature_valid")
  signatureImageUrl String?            @map("signature_image_url")
  // Campos de Habeas Data (Sección 2.2)
  consentAccepted   Boolean            @default(false) @map("consent_accepted")
  consentIp         String?            @map("consent_ip")
  consentTimestamp  DateTime?          @map("consent_timestamp")
  termsVersion      String?            @default("2026.1") @map("terms_version")

  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")
  puesto    PoliticalDivision? @relation("VoterPuesto", fields: [puestoId], references: [id])
  registrar User               @relation("Registrar", fields: [registrarId], references: [id])
  tenant    Tenant             @relation(fields: [tenantId], references: [id])

  @@unique([documentId, tenantId])
  @@index([tenantId])
  @@index([puestoId])
  @@map("voters")
}

model FinancialEntry {
  id          String        @id @default(cuid())
  type        EntryType
  amount      Decimal       @db.Decimal(15, 2)
  date        DateTime
  cneCode     CneCode
  description String
  tenantId    String        @map("tenant_id")
  vendorName  String        @map("vendor_name")
  vendorTaxId String        @map("vendor_tax_id")
  evidenceUrl String?       @map("evidence_url")
  reporterId  String        @map("reporter_id")
  status      FinanceStatus @default(PENDING)
  auditLog    Json?         @map("audit_log")
  createdAt   DateTime      @default(now()) @map("created_at")
  reporter    User          @relation(fields: [reporterId], references: [id])
  tenant      Tenant        @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([cneCode])
  @@map("financial_entries")
}

model WitnessReport {
  id              String            @id @default(cuid())
  tenantId        String            @map("tenant_id")
  witnessId       String            @map("witness_id")
  puestoId        String            @map("puesto_id")
  mesa            Int
  e14ImageUrl     String            @map("e14_image_url")
  candidateVotes  Int               @map("candidate_votes")
  totalTableVotes Int               @map("total_table_votes")
  observations    String?
  // Auditoría Forense (Sección 7.3)
  blockchainHash  String?           @map("blockchain_hash")
  timestampProof  DateTime?         @default(now()) @map("timestamp_proof")

  isSynced Boolean           @default(false) @map("is_synced")
  createdAt DateTime          @default(now()) @map("created_at")
  puesto    PoliticalDivision @relation(fields: [puestoId], references: [id])
  tenant    Tenant            @relation(fields: [tenantId], references: [id])
  witness   User              @relation(fields: [witnessId], references: [id])

  @@index([tenantId])
  @@index([puestoId, mesa])
  @@map("witness_reports")
}

// Gamification & Logistics (Sección 5.2 y 7)

model CampaignEvent {
  id          String   @id @default(cuid())
  name        String
  description String?
  date        DateTime
  location    String?
  points      Int      @default(0) // Puntos por asistir
  tenantId    String   @map("tenant_id")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  attendees PointLog[]

  @@index([tenantId])
  @@map("campaign_events")
}

model PointLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  amount    Int
  reason    String // ej. "Registro Votante", "Asistencia Evento"
  eventId   String?  @map("event_id")
  createdAt DateTime @default(now()) @map("created_at")

  user  User           @relation(fields: [userId], references: [id])
  event CampaignEvent? @relation(fields: [eventId], references: [id])

  @@index([userId])
  @@map("point_logs")
}

model InventoryItem {
  id        String  @id @default(cuid())
  name      String // ej. "Camiseta", "Gorra"
  sku       String?
  quantity  Int     @default(0)
  warehouse String? // Ubicación física
  tenantId  String  @map("tenant_id")

  tenant    Tenant              @relation(fields: [tenantId], references: [id])
  movements InventoryMovement[]

  @@index([tenantId])
  @@map("inventory_items")
}

model InventoryMovement {
  id        String       @id @default(cuid())
  itemId    String       @map("item_id")
  userId    String       @map("user_id")
  quantity  Int // Positivo (entrada) o Negativo (salida)
  type      MovementType
  createdAt DateTime     @default(now()) @map("created_at")

  item InventoryItem @relation(fields: [itemId], references: [id])
  user User          @relation(fields: [userId], references: [id])

  @@map("inventory_movements")
}

model VotingPlace {
  id           String   @id @default(cuid())
  nombre       String
  departamento String
  municipio    String
  direccion    String
  latitud      Float?
  longitud     Float?
  codigo       String?  @unique
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([municipio])
  @@index([departamento])
  @@map("voting_places")
}

enum TenantType {
  CANDIDACY
  PARTY
  GSC
}

enum Role {
  ADMIN
  CAMPAIGN_MANAGER
  ZONE_COORDINATOR
  WITNESS
  VOLUNTEER
}

enum DivisionType {
  COUNTRY
  DEPARTAMENTO
  MUNICIPIO
  ZONA
  PUESTO
}

enum EntryType {
  INCOME
  EXPENSE
}

enum FinanceStatus {
  PENDING
  APPROVED
  REJECTED
  REPORTED_CNE
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
}

enum CneCode {
  PUBLICIDAD_VALLAS // 108
  TRANSPORTE // 110
  SEDE_CAMPANA // 102
  ACTOS_PUBLICOS // 105
  OTROS
}
